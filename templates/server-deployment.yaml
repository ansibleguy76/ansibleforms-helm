
{{- $containers := (.Values.containers | default dict) }}
{{- $app := (.Values.applications | default dict) }}
{{- $server := ($containers.server | default dict) }}
{{- $liveness := ($server.liveness | default dict) }}
{{- $readiness := ($server.readiness | default dict) }}
{{- $resources := ($server.resources | default dict) }}
{{- $strategy := ($server.strategy | default dict) }}
{{- $limits := ($resources.limits | default dict) }}
{{- $requests := ($resources.requests | default dict) }}
{{- $appServer := ($app.server | default dict) }}
{{- $appEnv := ($appServer.env | default dict) }}
{{- $appMysql := ($app.mysql | default dict) }}
{{- $cmd := ($server.customCommand | default dict) }}
{{- $https := eq (atoi (default "0" $appEnv.HTTPS)) 1 }}
{{- $sensitive := dict "ENCRYPTION_SECRET" true "ADMIN_USERNAME" true "ADMIN_PASSWORD" true }}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: server
  namespace: {{ .Release.Namespace }}
spec:
  replicas: {{ $server.replicas | default 1 }}
  selector:
    matchLabels:
      app.kubernetes.io/name: server

  strategy:
    type: {{ $strategy.type | default "RollingUpdate" }}

  template:
    metadata:
      labels:
        app.kubernetes.io/name: server
    spec:
      serviceAccountName: {{ $server.serviceAccountName | default "default" }}


      {{- if $server.initContainers }}
      initContainers:
{{ toYaml $server.initContainers | nindent 8 }}
      {{- end }}

      containers:
        - name: server
          image: {{ $server.image | required "containers.server.image is required" }}
          imagePullPolicy: {{ $server.imagePullPolicy | default "IfNotPresent" }}

          {{- if $cmd.command }}
          command:
{{ toYaml $cmd.command | nindent 12 }}
          {{- end }}

          {{- if $cmd.args }}
          args:
{{ toYaml $cmd.args | nindent 12 }}
          {{- end }}

          ports:
            - containerPort: {{ if $https }}443{{ else }}80{{ end }}

          env:
            - name: PORT
              value: "{{ if $https }}443{{ else }}80{{ end }}"

            {{- range $key, $value := $appEnv }}
            {{- if not (index $sensitive $key) }}
            - name: {{ $key }}
              value: "{{ $value }}"
            {{- end }}
            {{- end }}

            - name: DB_HOST
              value: {{ $appMysql.host | default "mysql" | quote }}

            - name: DB_PORT
              value: {{ $appMysql.port | default "3306" | quote }}

            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: DB_USER

            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: DB_PASSWORD

            - name: ENCRYPTION_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: ENCRYPTION_SECRET

            - name: ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: ADMIN_USERNAME

            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: ADMIN_PASSWORD

          resources:
            limits:
              cpu: {{ $limits.cpu | default "500m" }}
              memory: {{ $limits.memory | default "512Mi" }}
            requests:
              cpu: {{ $requests.cpu | default "250m" }}
              memory: {{ $requests.memory | default "256Mi" }}

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              drop:
                - ALL

          stdin: {{ $server.stdin | default true }}
          tty: {{ $server.tty | default true }}

          livenessProbe:
            httpGet:
              path: {{ $liveness.path | default "/" }}
              port: {{ if $https }}443{{ else }}80{{ end }}
              scheme: {{ if $https }}HTTPS{{ else }}HTTP{{ end }}
            initialDelaySeconds: {{ $liveness.initialDelaySeconds | default 15 }}
            periodSeconds: {{ $liveness.periodSeconds | default 15 }}
            timeoutSeconds: {{ $liveness.timeoutSeconds | default 15 }}

          readinessProbe:
            httpGet:
              path: {{ $readiness.path | default "/" }}
              port: {{ if $https }}443{{ else }}80{{ end }}
              scheme: {{ if $https }}HTTPS{{ else }}HTTP{{ end }}
            initialDelaySeconds: {{ $readiness.initialDelaySeconds | default 15 }}
            periodSeconds: {{ $readiness.periodSeconds | default 15 }}
            timeoutSeconds: {{ $readiness.timeoutSeconds | default 15 }}

          volumeMounts:
            - mountPath: /app/dist/persistent
              name: server-persistent-storage
            - mountPath: /home/node/.ssh
              name: server-persistent-storage
            {{- with .Values.forms }}
              {{- with .configMap }}
                {{- if .enabled }}
            - name: forms-config
              mountPath: {{ .mountPath }}
              subPath: {{ .key }}
                {{- end }}
              {{- end }}

              {{- with .extraFormsConfigMap }}
                {{- if .enabled }}
            - name: forms-extra-config
              mountPath: {{ .mountPath }}
                {{- end }}
              {{- end }}

              {{- with .customJs }}
                {{- if .enabled }}
            - name: forms-custom-js
              mountPath: {{ .mountPath }}
              subPath: {{ .key }}
                {{- end }}
              {{- end }}
            {{- end }}

            {{- if $server.extraVolumeMounts }}
{{ toYaml $server.extraVolumeMounts | nindent 12 }}
            {{- end }}

      restartPolicy: Always

      volumes:
        - name: server-persistent-storage
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-server-pvc

        {{- with .Values.forms }}
          {{- with .configMap }}
            {{- if .enabled }}
        - name: forms-config
          configMap:
            name: {{ .name }}
            {{- end }}
          {{- end }}

          {{- with .extraFormsConfigMap }}
            {{- if .enabled }}
        - name: forms-extra-config
          configMap:
            name: {{ .name }}
            {{- end }}
          {{- end }}

          {{- with .customJs }}
            {{- if .enabled }}
        - name: forms-custom-js
          configMap:
            name: {{ .name }}
            {{- end }}
          {{- end }}
        {{- end }}

        {{- if .Values.extraVolumes }}
{{ toYaml .Values.extraVolumes | nindent 8 }}
        {{- end }}